<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Ash and Blood</title>


<style>
/* ---------------------------------------------------------------------------
[000] STYLES (BG RESET — NO TITLE LOGO)
--------------------------------------------------------------------------- */
:root{
  --curtain-ms: 0ms;
  --curtain-delay-ms: 0ms;

  /* Background / Title fade timing */
  --bg-delay-ms: 0ms;      /* only used if you add transition-delay */
  --bg-in-ms: 3000ms;

  /* Title uses the SAME fade as background (sync as one piece) */
  --title-delay-ms: 0ms;   /* keep 0 so bg+title start together */
  --title-in-ms: var(--bg-in-ms);

  /* Menu */
  --menu-delay-ms: 4050ms;    /* only used if you add transition-delay */
  --menu-in-ms: 4000ms;
}

html,body{
  margin:0;
  padding:0;
  background:#000;
  overflow:hidden;
  touch-action:none;
  font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color:#dfe7ff;
}

/* Canvas fade control (prevents gameplay pop-in later) */
canvas{
  display:block;
  opacity:0;
  transition: opacity var(--bg-in-ms) cubic-bezier(0.2, 0.0, 0.2, 1);
}
canvas.show{ opacity:1; }

#hud,#pad-left,#pad-right,#modeBtn,#fireBtn{opacity:0;pointer-events:none;}

/* Curtain (short, cinematic, prevents flash) */
#curtain{
  position:fixed;
  inset:0;
  background:#000;
  z-index:20000;
  opacity:1;
  pointer-events:none;
  transition: opacity var(--curtain-ms) linear var(--curtain-delay-ms);
}
#curtain.off{opacity:0;}

/* TitleScreen container fades as ONE piece (bg + any title you add later) */
#titleScreen{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  z-index:15000;

  opacity:0;
  pointer-events:none;
  padding:0;

  /* Use the long mood-light fade here */
  transition: opacity var(--bg-in-ms) cubic-bezier(0.2, 0.0, 0.2, 1);
}

#titleScreen.show{
  opacity:1;
  pointer-events:auto;
}

/* ✅ Instant kill-switch for title overlay (prevents fade-through during gameplay reveal) */
#titleScreen.hard-off{
  transition:none !important;
  opacity:0 !important;
  pointer-events:none !important;
  visibility:hidden !important;
}

/* Background layer (does NOT fade separately; parent controls fade) */
#titleScreen::before{
  content:"";
  position:absolute;
  inset:0;
  z-index:0;
  background-repeat:no-repeat;
  background-position:center;
  background-size:cover;
  background-image: url('img/background.png');
}

#titleCard{
  position:relative;
  z-index:1;
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:14px;
  padding:0;
}

#titleLogo{
  display:block;
  position:relative;
  z-index:2;

  width: min(100vw, 1200px);
  height:auto;

  margin:-15vh auto 4vh auto;

  pointer-events:none;
  background:transparent;
  filter: drop-shadow(0 14px 34px rgba(0,0,0,.6));
}

#mainMenu{
  margin:0;
  display:flex;
  flex-direction:column;
  gap:14px;
  opacity:0;
  transition: opacity var(--menu-in-ms) cubic-bezier(0.2, 0.0, 0.2, 1);
  transition-delay: var(--menu-delay-ms);
  pointer-events:none;
}
#mainMenu.show{opacity:1;pointer-events:auto;}

.menu-btn{
  display:block; /* ✅ IMPORTANT: makes centering consistent everywhere */
  width:min(520px,84vw);margin:0 auto;
  padding:14px 16px;border-radius:12px;
  background:rgba(18,24,34,.42);
  border:1px solid rgba(255,255,255,.16);
  color:#e9f0ff;font-weight:800;
  letter-spacing:.08em;text-transform:uppercase;
  backdrop-filter:blur(6px);
}
.menu-btn:active{transform:scale(.99);opacity:.92;}



/* ---------------------------------------------------------------------------
[000.5] BOOT SCREEN STYLES
--------------------------------------------------------------------------- */
#bootScreen{
  position:fixed;
  inset:0;
  background:#000;
  z-index:25000;
  display:flex;
  align-items:center;
  justify-content:center;
}

#bootScreen.off{
  display:none;
}

/* ---------------------------------------------------------------------------
[000.6] SAVE SLOTS MODAL (panel UI)
--------------------------------------------------------------------------- */

#slotModal{
  position:fixed;
  inset:0;
  z-index:50;

  /* keep it mounted so fade-out can animate */
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transition: opacity 220ms ease;

  /* safe gutters */
  padding: max(28px, env(safe-area-inset-top)) max(16px, env(safe-area-inset-right))
           max(28px, env(safe-area-inset-bottom)) max(16px, env(safe-area-inset-left));
}
#slotModal.show{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
}

#slotModal .slot-backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter: blur(8px);
}

/* Center panel, but respect modal padding gutters */
#slotModal .slot-panel{
  position:absolute;
  left:0;
  right:0;
  top:50%;
  transform: translateY(-50%);
  margin:0 auto;

  width:100%;
  max-width:560px;

  background:rgba(12,16,24,.78);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  box-shadow: 0 18px 60px rgba(0,0,0,.45);
  overflow:hidden;
}

#slotModal .slot-inner{
  padding:18px 18px 16px;
}

#slotModal h2{
  margin:4px 0 14px;
  text-align:center;
  letter-spacing:.18em;
  font-weight:800;
  font-size:18px;
  color:#e8f0ff;
}

#slotModal .panel{
  display:none;
}
#slotModal .panel.show{
  display:block;
}

#slotModal .slot-list{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin:0;
  padding:0;
}

#slotModal .slot-actions{
  display:flex;
  gap:12px;
}

#slotModal input{
  width:100%;
  padding:14px 14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.20);
  color:#eaf0ff;
  font-size:16px;
  outline:none;
}





/* ---------------------------------------------------------------------------
[000.7] OPTIONS MODAL
--------------------------------------------------------------------------- */

#optionsModal{
  position:fixed;
  inset:0;
  z-index:60;

  /* keep it mounted so fade-out can animate */
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transition: opacity 220ms ease;

  /* safe gutters */
  padding: max(28px, env(safe-area-inset-top)) max(16px, env(safe-area-inset-right))
           max(28px, env(safe-area-inset-bottom)) max(16px, env(safe-area-inset-left));
}
#optionsModal.show{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
}

#optionsModal .options-backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter: blur(8px);
}

/* Center panel, but respect modal padding gutters */
#optionsModal .options-panel{
  position:absolute;
  left:0;
  right:0;
  top:50%;
  transform: translateY(-50%);
  margin:0 auto;

  width:100%;
  max-width:560px;

  background:rgba(12,16,24,.78);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  box-shadow: 0 18px 60px rgba(0,0,0,.45);
  overflow:hidden;
}

#optionsModal .options-inner{
  padding:18px 18px 16px;
}

#optionsModal h2{
  margin:4px 0 14px;
  text-align:center;
  letter-spacing:.18em;
  font-weight:800;
  font-size:18px;
  color:#e8f0ff;
}

#optionsModal .opt-row{
  display:flex;
  align-items:center;
  gap:12px;
  margin:12px 0;
}

#optionsModal .opt-label{
  font-weight:800;
  letter-spacing:.12em;
  opacity:.9;
  min-width:70px;
}

#optionsModal input[type="range"]{
  flex:1;
}

#musicVolLabel{
  min-width:48px;
  text-align:right;
  font-weight:800;
  letter-spacing:.06em;
  opacity:.9;
}

#musicToggleBtn.off{
  opacity:.7;
}


/* ---------------------------------------------------------------------------
[000.8] UI: LOAD SAVE PANEL (modal textbox)
--------------------------------------------------------------------------- */
#loadModal{
  position:fixed;
  inset:0;
  z-index:26000;
  display:none;
  align-items:center;
  justify-content:center;

  /* ✅ stronger visible gutter + safe-area support */
  padding-top:    calc(28px + env(safe-area-inset-top));
  padding-right:  calc(28px + env(safe-area-inset-right));
  padding-bottom: calc(28px + env(safe-area-inset-bottom));
  padding-left:   calc(28px + env(safe-area-inset-left));
  box-sizing:border-box;
}
#loadModal.show{ display:flex; }

#loadModal .backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.62);
}

#loadModal .panel{
  position:relative;
  z-index:1;

  width:min(640px, 100%);
  max-height:min(70vh, 620px);
  overflow:auto;

  border-radius:14px;
  background:rgba(12,16,22,.88);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 22px 60px rgba(0,0,0,.55);
  backdrop-filter: blur(10px);
  padding:16px;
}

#loadModal .title{
  font-weight:900;
  letter-spacing:.08em;
  text-transform:uppercase;
  margin:6px 0 12px 0;
}

#saveList{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.save-item{
  width:100%;
  text-align:left;
  padding:12px 12px;
  border-radius:12px;
  background:rgba(18,24,34,.42);
  border:1px solid rgba(255,255,255,.16);
  color:#e9f0ff;
  font-weight:800;
  letter-spacing:.04em;
}

.save-item:active{ transform:scale(.99); opacity:.92; }

.save-empty{
  padding:12px;
  border-radius:12px;
  background:rgba(255,255,255,.06);
  border:1px dashed rgba(255,255,255,.18);
  color:rgba(233,240,255,.75);
}

#btnCloseLoad{
  margin-top:12px;
  width:100%;
}


/* ---------------------------------------------------------------------------
[000.9] CONFIRM MODAL (apply changes?)
--------------------------------------------------------------------------- */

#confirmModal{
  position:fixed;
  inset:0;
  z-index:70;

  /* keep it mounted so fade-out can animate */
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transition: opacity 220ms ease;

  /* safe gutters */
  padding: max(28px, env(safe-area-inset-top)) max(16px, env(safe-area-inset-right))
           max(28px, env(safe-area-inset-bottom)) max(16px, env(safe-area-inset-left));
}
#confirmModal.show{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
}

#confirmModal .confirm-backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter: blur(8px);
}

/* Center panel, but respect modal padding gutters */
#confirmModal .confirm-panel{
  position:absolute;
  left:0;
  right:0;
  top:50%;
  transform: translateY(-50%);
  margin:0 auto;

  width:100%;
  max-width:520px;

  background:rgba(12,16,24,.78);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  box-shadow: 0 18px 60px rgba(0,0,0,.45);
  overflow:hidden;
}

#confirmModal .confirm-inner{
  padding:18px 18px 16px;
  text-align:center;
}

#confirmModal .confirm-title{
  margin:4px 0 12px;
  font-weight:900;
  letter-spacing:.18em;
  font-size:18px;
  color:#e8f0ff;
}

#confirmModal .confirm-actions{
  display:flex;
  gap:12px;
  justify-content:center;
  margin-top:14px;
}



/* ---------------------------------------------------------------------------
[000.10] ALERT MODAL (replaces alert())
--------------------------------------------------------------------------- */

#alertModal{
  position:fixed;
  inset:0;
  z-index:75;

  /* keep it mounted so fade-out can animate */
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transition: opacity 220ms ease;

  /* safe gutters */
  padding: max(28px, env(safe-area-inset-top)) max(16px, env(safe-area-inset-right))
           max(28px, env(safe-area-inset-bottom)) max(16px, env(safe-area-inset-left));
}
#alertModal.show{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
}

#alertModal .alert-backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter: blur(8px);
}

/* Center panel, but respect modal padding gutters */
#alertModal .alert-panel{
  position:absolute;
  left:0;
  right:0;
  top:50%;
  transform: translateY(-50%);
  margin:0 auto;

  width:100%;
  max-width:520px;

  background:rgba(12,16,24,.78);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  box-shadow: 0 18px 60px rgba(0,0,0,.45);
  overflow:hidden;
}

#alertModal .alert-inner{
  padding:18px 18px 16px;
  text-align:center;
}

#alertModal .alert-title{
  margin:4px 0 10px;
  font-weight:900;
  letter-spacing:.18em;
  font-size:18px;
  color:#e8f0ff;
}

#alertModal .alert-msg{
  margin:0 0 14px;
  opacity:.92;
  line-height:1.35;
}

/* ---------------------------------------------------------------------------
UI BUTTON FEEDBACK (visual press)
(override-only: placed late so it wins)
--------------------------------------------------------------------------- */

button,
.menu-btn,
.menu-row button{
  transition: transform 110ms ease, filter 110ms ease, background 110ms ease, box-shadow 110ms ease;
}

button.is-pressed,
.menu-btn.is-pressed,
.menu-row button.is-pressed{
  transform: translateY(1px) scale(0.99);
  filter: brightness(1.12);
}

button:active,
.menu-btn:active,
.menu-row button:active{
  transform: translateY(1px) scale(0.99);
  filter: brightness(1.12);
}




</style>

</head>

<body>

<div id="curtain"></div>

<!-- ---------------------------------------------------------------------------
[H000] BOOT SCREEN (sound unlock)
--------------------------------------------------------------------------- -->
<div id="bootScreen">
  <button id="bootStartBtn" class="menu-btn">START</button>
</div>

<!-- ---------------------------------------------------------------------------
[H001] TITLE SCREEN + MAIN MENU (single unified screen)
--------------------------------------------------------------------------- -->
<div id="titleScreen">
  <div id="titleCard">
    <img id="titleLogo" alt="ASH AND BLOOD" src="img/title.png">

    <!-- MAIN MENU -->
    <div id="mainMenu">
      <button id="btnNew" class="menu-btn">START GAME</button>
      <button id="btnOptions" class="menu-btn">OPTIONS</button>
    </div>
  </div>
</div>


<!-- ---------------------------------------------------------------------------
[H002] SAVE SLOTS PANEL (textbox)
--------------------------------------------------------------------------- -->
<div id="slotModal" aria-label="Save Slots Panel">
  <div class="slot-backdrop"></div>

  <!-- PANEL A: CHOOSE SLOT -->
  <div class="slot-panel" id="panelSlots">
    <div class="slot-title">CHOOSE SAVE SLOT</div>

    <div id="slotList"></div>

    <div class="slot-divider" aria-hidden="true"></div>

    <button id="btnSlotsClose" class="menu-btn">CLOSE</button>
  </div>

  <!-- PANEL B: NAME SURVIVOR -->
  <div class="slot-panel" id="panelName">
    <div class="slot-title">NAME SURVIVOR</div>

    <input id="nameInput" type="text" maxlength="16" placeholder="Enter name..." />

    <div class="slot-divider" aria-hidden="true"></div>

    <div class="slot-row">
      <button id="btnNameConfirm" class="menu-btn">CONFIRM</button>
      <button id="btnNameCancel" class="menu-btn">CANCEL</button>
    </div>
  </div>

  <!-- PANEL C: ACTIONS -->
  <div class="slot-panel" id="panelActions">
    <div class="slot-title" id="actionTitle">SAVE</div>

    <div class="slot-divider" aria-hidden="true"></div>

    <div class="slot-row">
      <button id="btnLoadSlot" class="menu-btn">LOAD SAVE</button>
      <button id="btnDeleteSlot" class="menu-btn">DELETE SAVE</button>
    </div>

    <button id="btnActionsClose" class="menu-btn">CLOSE</button>
  </div>

  <!-- PANEL D: CONFIRM DELETE -->
  <div class="slot-panel" id="panelConfirm">
    <div class="slot-title">ARE YOU SURE?</div>

    <div class="slot-divider" aria-hidden="true"></div>

    <div class="slot-row">
      <button id="btnDeleteYes" class="menu-btn">YES</button>
      <button id="btnDeleteNo" class="menu-btn">NO</button>
    </div>

    <button id="btnConfirmClose" class="menu-btn">CLOSE</button>
  </div>
</div>

<!-- ---------------------------------------------------------------------------
[H003] OPTIONS PANEL (textbox)
--------------------------------------------------------------------------- -->
<div id="optionsModal" aria-label="Options Panel">
  <div class="options-backdrop"></div>

  <div class="options-panel">
    <div class="slot-title">OPTIONS</div>

    <div class="options-row">
      <label for="musicVol">MUSIC</label>
      <input id="musicVol" type="range" min="0" max="100" value="50" />
      <button id="musicToggleBtn" class="menu-btn option-toggle" type="button">ON</button>
    </div>

    <div class="options-row" style="justify-content:flex-end; margin-top:-6px;">
      <div id="musicVolLabel" class="options-value">50%</div>
    </div>

    <button id="btnOptionsClose" class="menu-btn">CLOSE</button>
  </div>
</div>

<!-- ---------------------------------------------------------------------------
[H004] CONFIRM MODAL (in-game)
--------------------------------------------------------------------------- -->
<div id="confirmModal" class="modal">
  <div class="confirm-backdrop"></div>
  <div class="confirm-panel">
    <div class="confirm-inner">
      <div class="confirm-title">APPLY CHANGES?</div>

      <div class="confirm-actions">
        <button id="btnConfirmNo"  class="menu-btn">NO</button>
        <button id="btnConfirmYes" class="menu-btn">YES</button>
      </div>
    </div>
  </div>
</div>


<!-- ---------------------------------------------------------------------------
[H005] ALERT MODAL (replaces browser alert())
--------------------------------------------------------------------------- -->
<div id="alertModal" aria-label="Alert Modal">
  <div class="alert-backdrop"></div>

  <div class="alert-panel">
    <div class="slot-title">NOTICE</div>
    <div id="alertMsg" class="alert-msg">Message</div>
    <button id="btnAlertOk" class="menu-btn">OK</button>
  </div>
</div>




<!-- ---------------------------------------------------------------------------
[GX01] GAMEPLAY UI + CANVAS
--------------------------------------------------------------------------- -->

<div id="hud">
  <div class="hud-pill">HP <span id="hp">100</span></div>
  <div class="hud-pill">LV <span id="lv">1</span></div>
</div>

<div id="pad-left" class="pad"><div class="stick"></div></div>
<div id="pad-right" class="pad"><div class="stick"></div></div>

<div id="modeBtn">AUTO FIRE</div>
<div id="fireBtn">FIRE</div>

<canvas id="game"></canvas>

<script>
/* ---------------------------------------------------------------------------
[001] UTIL: seeded RNG
--------------------------------------------------------------------------- */
function RNG(seed){
  this.s=seed>>>0
}
RNG.prototype.next=function(){
  this.s=(this.s*1664525+1013904223)>>>0
  return this.s/4294967296
}

/* ---------------------------------------------------------------------------
[002] CANVAS + CAMERA
--------------------------------------------------------------------------- */
const canvas=document.getElementById('game')
const ctx=canvas.getContext('2d')
function resize(){
  canvas.width=innerWidth
  canvas.height=innerHeight
}
addEventListener('resize',resize)
resize()

const camera={x:0,y:0,zoom:1}

/* ---------------------------------------------------------------------------
[003] INPUT: virtual sticks
--------------------------------------------------------------------------- */
function Stick(el){
  this.el=el
  this.knob=el.querySelector('.stick')
  this.active=false
  this.dx=0; this.dy=0
  el.addEventListener('pointerdown',e=>{
    this.active=true
    this.ox=e.clientX; this.oy=e.clientY
  })
  addEventListener('pointermove',e=>{
    if(!this.active) return
    let x=e.clientX-this.ox
    let y=e.clientY-this.oy
    const d=Math.hypot(x,y)
    if(d>40){x*=40/d;y*=40/d}
    this.dx=x/40; this.dy=y/40
    this.knob.style.transform=`translate(${x}px,${y}px)`
  })
  addEventListener('pointerup',()=>{
    this.active=false
    this.dx=this.dy=0
    this.knob.style.transform='translate(0,0)'
  })
}
const moveStick=new Stick(document.getElementById('pad-left'))
const aimStick=new Stick(document.getElementById('pad-right'))

/* ---------------------------------------------------------------------------
[004] WORLD: procedural outdoor map
--------------------------------------------------------------------------- */
const TILE=96
const MAP_W=20, MAP_H=20
const world=[]
const rng=new RNG(12345)

for(let y=0;y<MAP_H;y++){
  for(let x=0;x<MAP_W;x++){
    world.push({
      x,y,
      type:rng.next()<.1?'building':'street'
    })
  }
}

/* ---------------------------------------------------------------------------
[005] PLAYER
--------------------------------------------------------------------------- */
const player={
  x:MAP_W*TILE/2,
  y:MAP_H*TILE/2,
  a:0,
  hp:100
}

/* ---------------------------------------------------------------------------
[006] ENEMIES
--------------------------------------------------------------------------- */
const enemies=[]
for(let i=0;i<6;i++){
  enemies.push({
    x:rng.next()*MAP_W*TILE,
    y:rng.next()*MAP_H*TILE,
    a:rng.next()*Math.PI*2,
    state:'idle'
  })
}

/* ---------------------------------------------------------------------------
[007] UPDATE LOOP
--------------------------------------------------------------------------- */
let autoFire=true
const modeBtn=document.getElementById('modeBtn')
modeBtn.onclick=()=>{
  autoFire=!autoFire
  modeBtn.textContent=autoFire?'AUTO FIRE':'MANUAL'
}

function update(dt){
  // movement
  const spd=2
  if(moveStick.active){
    player.x+=moveStick.dx*spd*dt
    player.y+=moveStick.dy*spd*dt
    if(!aimStick.active){
      player.a=Math.atan2(moveStick.dy,moveStick.dx)
    }
  }
  if(aimStick.active){
    player.a=Math.atan2(aimStick.dy,aimStick.dx)
  }

  camera.x=player.x
  camera.y=player.y
}

/* ---------------------------------------------------------------------------
[008] RENDER
--------------------------------------------------------------------------- */
function draw(){
  ctx.setTransform(1,0,0,1,0,0)
  ctx.clearRect(0,0,canvas.width,canvas.height)

  ctx.translate(canvas.width/2,canvas.height/2)
  ctx.scale(camera.zoom,camera.zoom)
  ctx.translate(-camera.x,-camera.y)

  // tiles
  for(const t of world){
    ctx.fillStyle=t.type==='building'?'#2b3444':'#3a4558'
    ctx.fillRect(t.x*TILE,t.y*TILE,TILE,TILE)
  }

  // enemies
  for(const e of enemies){
    ctx.fillStyle='#6aff6a'
    ctx.beginPath()
    ctx.arc(e.x,e.y,14,0,Math.PI*2)
    ctx.fill()
  }

  // player
  ctx.save()
  ctx.translate(player.x,player.y)
  ctx.rotate(player.a)
  ctx.fillStyle='#dfe7ff'
  ctx.fillRect(-10,-14,20,28)
  ctx.fillStyle='#ff5555'
  ctx.fillRect(8,-3,10,6)
  ctx.restore()

  // vignette
  const g=ctx.createRadialGradient(
    camera.x,camera.y,200,
    camera.x,camera.y,800
  )
  g.addColorStop(0,'rgba(0,0,0,0)')
  g.addColorStop(1,'rgba(0,0,0,.6)')
  ctx.fillStyle=g
  ctx.fillRect(
    camera.x-1000,camera.y-1000,
    2000,2000
  )
}

/* ---------------------------------------------------------------------------
[009] TITLE FLOW + SAVE SLOTS (black -> title -> menu)
--------------------------------------------------------------------------- */

const titleScreen = document.getElementById('titleScreen');
const curtain     = document.getElementById('curtain');
const mainMenu    = document.getElementById('mainMenu');
const btnNew      = document.getElementById('btnNew');
const btnOptions  = document.getElementById('btnOptions');

/* OPTIONS UI */
const optionsModal    = document.getElementById('optionsModal');
const optionsBackdrop = optionsModal ? optionsModal.querySelector('.options-backdrop') : null;
const musicVol        = document.getElementById('musicVol');
const musicVolLabel   = document.getElementById('musicVolLabel');
const musicToggleBtn  = document.getElementById('musicToggleBtn');
const btnOptionsClose = document.getElementById('btnOptionsClose');

/* CONFIRM MODAL */
const confirmModal    = document.getElementById('confirmModal');
const confirmBackdrop = confirmModal ? confirmModal.querySelector('.confirm-backdrop') : null;
const btnConfirmYes   = document.getElementById('btnConfirmYes');
const btnConfirmNo    = document.getElementById('btnConfirmNo');

/* ALERT MODAL (NEW) */
const alertModal      = document.getElementById('alertModal');
const alertBackdrop   = alertModal ? alertModal.querySelector('.alert-backdrop') : null;
const alertMsgEl      = document.getElementById('alertMsg');
const btnAlertOk      = document.getElementById('btnAlertOk');

/* --------------------------
   OPTIONS PANEL (staged apply/revert + slider/toggle coupling)
-------------------------- */
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
const MUSIC_ON_THRESHOLD = 0.001; // internal

let optionsDirty = false;
let optionsSnapshot = null; // { vol:number(0..1) }

function getVolSafe(){
  const v = (typeof getMusicVolume === 'function') ? +getMusicVolume() : 0.5;
  return (Number.isFinite(v) ? clamp(v,0,1) : 0.5);
}
function isMusicOnByVol(v01){ return v01 > MUSIC_ON_THRESHOLD; }

function snapshotOptions(){
  optionsSnapshot = { vol: getVolSafe() };
  optionsDirty = false;
}

function syncOptionsUI(){
  if(!musicVol || !musicToggleBtn) return;

  const vol01 = getVolSafe();
  const pct = clamp(Math.round(vol01 * 100), 0, 100);

  musicVol.value = String(pct);
  if(musicVolLabel) musicVolLabel.textContent = pct + '%';

  const on = isMusicOnByVol(vol01);
  musicToggleBtn.textContent = on ? 'ON' : 'OFF';
  musicToggleBtn.classList.toggle('off', !on);
}

/* --------------------------
   UI BUTTON FEEDBACK (press state + click SFX)
-------------------------- */
function installUIButtonFX(root=document){
  // root can be document, element, or a single button
  const scope = root && root.nodeType === 1 ? root : document;

  let btns = [];
  if(root && root.tagName === 'BUTTON') btns = [root];
  else btns = Array.from(scope.querySelectorAll('button'));

  for(const btn of btns){
    if(btn.dataset.fxBound === '1') continue;
    btn.dataset.fxBound = '1';

    const pressOn  = ()=>btn.classList.add('is-pressed');
    const pressOff = ()=>btn.classList.remove('is-pressed');

    btn.addEventListener('pointerdown', pressOn, {passive:true});
    btn.addEventListener('pointerup', pressOff, {passive:true});
    btn.addEventListener('pointercancel', pressOff, {passive:true});
    btn.addEventListener('pointerleave', pressOff, {passive:true});

    // click SFX for every button press
    btn.addEventListener('click', ()=>{
      if(typeof playClickSfx === 'function') playClickSfx();
    });
  }
}

/* ✅ in-game confirm modal (no browser prompt) */
function openConfirmModal(onYes, onNo){
  if(!confirmModal) return;
  confirmModal.classList.add('show');

  const cleanup = ()=>{
    confirmModal.classList.remove('show');
    btnConfirmYes && btnConfirmYes.removeEventListener('click', yesHandler);
    btnConfirmNo  && btnConfirmNo.removeEventListener('click', noHandler);
    confirmBackdrop && confirmBackdrop.removeEventListener('click', noHandler);
  };

  const yesHandler = ()=>{
    cleanup();
    if(typeof onYes === 'function') onYes();
  };
  const noHandler = ()=>{
    cleanup();
    if(typeof onNo === 'function') onNo();
  };

  btnConfirmYes && btnConfirmYes.addEventListener('click', yesHandler);
  btnConfirmNo  && btnConfirmNo.addEventListener('click', noHandler);
  confirmBackdrop && confirmBackdrop.addEventListener('click', noHandler);
}

/* ✅ in-game alert modal (replaces alert()) */
function openAlertModal(message, onOk){
  if(!alertModal) return;
  if(alertMsgEl) alertMsgEl.textContent = message || 'Notice';
  alertModal.classList.add('show');

  const cleanup = ()=>{
    alertModal.classList.remove('show');
    btnAlertOk && btnAlertOk.removeEventListener('click', okHandler);
    alertBackdrop && alertBackdrop.removeEventListener('click', okHandler);
  };

  const okHandler = ()=>{
    cleanup();
    if(typeof onOk === 'function') onOk();
  };

  btnAlertOk && btnAlertOk.addEventListener('click', okHandler);
  alertBackdrop && alertBackdrop.addEventListener('click', okHandler);
}

function openOptions(){
  if(!optionsModal) return;
  snapshotOptions();
  syncOptionsUI();
  optionsModal.classList.add('show');
}

function closeOptionsWithPrompt(){
  if(!optionsModal) return;

  if(!optionsDirty){
    optionsModal.classList.remove('show');
    return;
  }

  openConfirmModal(
    // YES: keep current settings (already live-previewed)
    ()=>{
      optionsDirty = false;
      optionsSnapshot = null;
      optionsModal.classList.remove('show');
    },
    // NO: revert snapshot
    ()=>{
      if(optionsSnapshot){
        if(typeof setMusicVolume === 'function') setMusicVolume(optionsSnapshot.vol);
      }
      optionsDirty = false;
      optionsSnapshot = null;
      optionsModal.classList.remove('show');
    }
  );
}

if(optionsBackdrop){
  optionsBackdrop.addEventListener('click', closeOptionsWithPrompt);
}
if(btnOptionsClose){
  btnOptionsClose.addEventListener('click', closeOptionsWithPrompt);
}

/* Slider coupling */
if(musicVol){
  musicVol.addEventListener('input', ()=>{
    const pct = clamp(parseInt(musicVol.value,10) || 0, 0, 100);
    if(musicVolLabel) musicVolLabel.textContent = pct + '%';

    if(typeof setMusicVolume === 'function'){
      setMusicVolume(pct / 100);
      optionsDirty = true;
      syncOptionsUI();
    }
  });
}

/* Toggle coupling */
if(musicToggleBtn){
  musicToggleBtn.addEventListener('click', ()=>{
    if(typeof setMusicEnabled !== 'function' || typeof getMusicVolume !== 'function') return;

    const vol01 = getVolSafe();
    const currentlyOn = isMusicOnByVol(vol01);

    setMusicEnabled(!currentlyOn);
    optionsDirty = true;
    syncOptionsUI();
  });
}

/* SAVE SLOTS UI */
const slotModal      = document.getElementById('slotModal');
const slotBackdrop   = slotModal.querySelector('.slot-backdrop');

const panelSlots     = document.getElementById('panelSlots');
const panelName      = document.getElementById('panelName');
const panelActions   = document.getElementById('panelActions');
const panelConfirm   = document.getElementById('panelConfirm');

const slotList       = document.getElementById('slotList');

const btnSlotsClose   = document.getElementById('btnSlotsClose');
const nameInput       = document.getElementById('nameInput');
const btnNameConfirm  = document.getElementById('btnNameConfirm');
const btnNameCancel   = document.getElementById('btnNameCancel');

const actionTitle     = document.getElementById('actionTitle');
const btnLoadSlot     = document.getElementById('btnLoadSlot');
const btnDeleteSlot   = document.getElementById('btnDeleteSlot');
const btnActionsClose = document.getElementById('btnActionsClose');

const btnDeleteYes    = document.getElementById('btnDeleteYes');
const btnDeleteNo     = document.getElementById('btnDeleteNo');
const btnConfirmClose = document.getElementById('btnConfirmClose');

/* YOU can change this later */
const SLOT_COUNT = 5;

/* State */
let selectedSlot = null;
let currentPanel = 'slots';
let previousPanel = 'slots';

/* Title timers */
let titleTimers = [];
function clearTitleTimers(){
  for(const id of titleTimers) clearTimeout(id);
  titleTimers = [];
}

/* Storage keys */
function slotKey(i){ return `AAB_SLOT_${i}`; }
function saveKey(i){ return `AAB_SAVE_${i}`; }

function getSlotName(i){
  const raw = localStorage.getItem(slotKey(i));
  if(!raw) return null;
  try{
    const obj = JSON.parse(raw);
    return obj && obj.name ? obj.name : null;
  }catch(e){
    return null;
  }
}
function slotHasSave(i){
  return !!localStorage.getItem(saveKey(i));
}

/* Panel control */
function hideAllPanels(){
  panelSlots.classList.remove('show');
  panelName.classList.remove('show');
  panelActions.classList.remove('show');
  panelConfirm.classList.remove('show');
}
function showPanel(which){
  hideAllPanels();
  currentPanel = which;

  if(which === 'slots')   panelSlots.classList.add('show');
  if(which === 'name')    panelName.classList.add('show');
  if(which === 'actions') panelActions.classList.add('show');
  if(which === 'confirm') panelConfirm.classList.add('show');
}
function goBack(){
  showPanel(previousPanel);
}

/* Open / Close modal */
function openSlots(){
  selectedSlot = null;
  previousPanel = 'slots';
  showPanel('slots');
  rebuildSlotList();
  slotModal.classList.add('show');
}
function closeSlots(){
  slotModal.classList.remove('show');
  selectedSlot = null;
  previousPanel = 'slots';
  currentPanel = 'slots';
  nameInput.value = '';
}

/* Build slot buttons */
function rebuildSlotList(){
  slotList.innerHTML = '';

  for(let i=1;i<=SLOT_COUNT;i++){
    const nm = getSlotName(i);
    const has = slotHasSave(i);

    const btn = document.createElement('button');
    btn.className = 'menu-btn';
    btn.textContent = nm ? nm : `${i} ---NEW GAME---`;

    btn.addEventListener('click', ()=>{
      selectedSlot = i;

      if(nm && has){
        actionTitle.textContent = nm;
        previousPanel = 'slots';
        showPanel('actions');
      }else{
        previousPanel = 'slots';
        showPanel('name');
        nameInput.value = '';
        setTimeout(()=>nameInput.focus(), 50);
      }
    });

    slotList.appendChild(btn);
  }

  // ensure press feedback + click SFX on dynamic slot buttons
  installUIButtonFX(slotList);
}

/* Cinematic transition into game */
function cinematicIntoGame(){
  clearTitleTimers();

  curtain.style.transition = 'opacity 900ms linear';
  curtain.classList.remove('off');

  fadeOutMenuMusic(900);

  closeSlots();
  if(optionsModal && optionsModal.classList.contains('show')){
    optionsDirty = false;
    optionsSnapshot = null;
    optionsModal.classList.remove('show');
  }

  mainMenu.classList.remove('show');
  titleScreen.classList.remove('show');

  titleScreen.classList.add('hard-off');
  titleScreen.style.display = 'none';

  const MIN_BLACK_MS = 2000;
  const FADE_TO_BLACK_MS = 900;
  const blackAt = performance.now() + FADE_TO_BLACK_MS;

  setTimeout(()=>{
    let maybePromise = null;
    try{ maybePromise = startGameplay(); }catch(e){ maybePromise = null; }

    const waitMinBlack = new Promise(res=>{
      const remaining = Math.max(0, (blackAt + MIN_BLACK_MS) - performance.now());
      setTimeout(res, remaining);
    });

    Promise.resolve(maybePromise).then(()=>waitMinBlack).then(()=>{
      curtain.style.transition = 'opacity 1200ms cubic-bezier(0.2,0,0.2,1)';
      curtain.classList.add('off');
    });
  }, FADE_TO_BLACK_MS + 50);
}

/* NAME panel actions */
btnNameConfirm.addEventListener('click', ()=>{
  if(!selectedSlot) return;

  const name = (nameInput.value || '').trim();
  if(!name){
    openAlertModal('Please enter a name');
    return;
  }

  localStorage.setItem(slotKey(selectedSlot), JSON.stringify({
    name,
    createdAt: Date.now()
  }));

  localStorage.setItem(saveKey(selectedSlot), JSON.stringify({
    v: 1,
    name,
    createdAt: Date.now()
  }));

  if(typeof playConfirmSfx === 'function') playConfirmSfx();

  cinematicIntoGame();
});

btnNameCancel.addEventListener('click', ()=>{
  nameInput.value = '';
  goBack();
});

/* ACTIONS panel actions */
btnLoadSlot.addEventListener('click', ()=>{
  if(!selectedSlot) return;
  const raw = localStorage.getItem(saveKey(selectedSlot));
  if(!raw){
    openAlertModal('No saved game found', ()=>{
      rebuildSlotList();
      showPanel('slots');
    });
    return;
  }

  if(typeof playConfirmSfx === 'function') playConfirmSfx();

  cinematicIntoGame();
});

btnDeleteSlot.addEventListener('click', ()=>{
  previousPanel = 'actions';
  showPanel('confirm');
});

btnActionsClose.addEventListener('click', ()=>{
  rebuildSlotList();
  showPanel('slots');
});

/* CONFIRM panel actions */
btnDeleteYes.addEventListener('click', ()=>{
  if(!selectedSlot) return;

  localStorage.removeItem(saveKey(selectedSlot));
  localStorage.removeItem(slotKey(selectedSlot));

  selectedSlot = null;

  rebuildSlotList();
  showPanel('slots');
});

btnDeleteNo.addEventListener('click', ()=>goBack());
btnConfirmClose.addEventListener('click', ()=>goBack());

slotBackdrop.addEventListener('click', ()=>{
  if(currentPanel === 'slots') closeSlots();
  else goBack();
});

btnSlotsClose.addEventListener('click', closeSlots);

btnNew.addEventListener('click', openSlots);

if(btnOptions) btnOptions.addEventListener('click', openOptions);

// global button feedback for static buttons
installUIButtonFX();

/* Existing title sequence (menu delay starts when title fade begins) */
function runTitleSequence(){
  clearTitleTimers();

  const BLACK_HOLD_MS = 2000;

  curtain.classList.remove('off');

  titleScreen.style.display = 'flex';
  titleScreen.classList.remove('hard-off');

  titleScreen.classList.remove('show');
  mainMenu.classList.remove('show');

  const t1 = setTimeout(()=>{
    titleScreen.classList.add('show');
    curtain.classList.add('off');
    mainMenu.classList.add('show');
  }, BLACK_HOLD_MS);

  titleTimers.push(t1);
}


/* ---------------------------------------------------------------------------
[010] GAME LOOP (disabled until later phases)
--------------------------------------------------------------------------- */
function startGameplay(){
  const canvas = document.getElementById('game');

  // reveal gameplay only when this is explicitly called
  canvas.classList.add('show');

  let last = 0;
  function loop(t){
    const dt = (t - last) / 16;
    last = t;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
}

/* ---------------------------------------------------------------------------
[011] AUDIO (menu music + fades)
--------------------------------------------------------------------------- */

let audioCtx = null;
let masterGain = null;
let musicGain = null;

let menuMusicOsc = null;
let menuMusicLFO = null;

function ensureAudio(){
  if(audioCtx) return;
  const AC = window.AudioContext || window.webkitAudioContext;
  audioCtx = new AC();

  masterGain = audioCtx.createGain();
  masterGain.gain.value = 1;
  masterGain.connect(audioCtx.destination);

  musicGain = audioCtx.createGain();
  musicGain.gain.value = 0.5;
  musicGain.connect(masterGain);
}

function setMusicVolume(v01){
  ensureAudio();
  const v = Math.max(0, Math.min(1, +v01 || 0));
  if(musicGain) musicGain.gain.setTargetAtTime(v, audioCtx.currentTime, 0.02);
}
function getMusicVolume(){
  try{
    return musicGain ? (musicGain.gain.value || 0) : 0.5;
  }catch(e){
    return 0.5;
  }
}

function setMusicEnabled(on){
  ensureAudio();
  if(on){
    startMenuMusic();
  }else{
    stopMenuMusic(120);
  }
}
function startMenuMusic(){
  ensureAudio();
  if(menuMusicOsc) return;

  // gritty, minimal tension bed
  const osc = audioCtx.createOscillator();
  osc.type = 'sawtooth';
  osc.frequency.value = 54;

  const lfo = audioCtx.createOscillator();
  lfo.type = 'sine';
  lfo.frequency.value = 0.18;

  const lfoGain = audioCtx.createGain();
  lfoGain.gain.value = 7.5;

  lfo.connect(lfoGain);
  lfoGain.connect(osc.frequency);

  osc.connect(musicGain);

  osc.start();
  lfo.start();

  menuMusicOsc = osc;
  menuMusicLFO = lfo;
}
function stopMenuMusic(ms=180){
  if(!audioCtx || !menuMusicOsc) return;

  const t = audioCtx.currentTime;
  const g = musicGain.gain;

  try{
    g.cancelScheduledValues(t);
    g.setTargetAtTime(0.0001, t, (ms/1000)/3);
  }catch(e){}

  setTimeout(()=>{
    try{ menuMusicOsc.stop(); }catch(e){}
    try{ menuMusicLFO.stop(); }catch(e){}
    menuMusicOsc = null;
    menuMusicLFO = null;

    // restore volume to current setting
    const v = getMusicVolume();
    if(musicGain) musicGain.gain.value = v;
  }, ms + 50);
}

function fadeOutMenuMusic(ms=900){
  ensureAudio();
  if(!musicGain) return;

  const t = audioCtx.currentTime;
  const g = musicGain.gain;

  try{
    g.cancelScheduledValues(t);
    g.setTargetAtTime(0.0001, t, (ms/1000)/3);
  }catch(e){}
}

/* ---------------------------------------------------------------------------
UI SFX (no external files; uses WebAudio)
--------------------------------------------------------------------------- */

function _sfxGainBase(){
  // Keep simple for now: tie SFX loudness loosely to music volume if available.
  let vol = 0.6;
  try{
    if(typeof getMusicVolume === 'function') vol = Math.max(0, Math.min(1, +getMusicVolume()));
  }catch(e){}
  // gain in linear space (small = safe)
  return 0.03 + (vol * 0.05);
}

function playTone(freqHz, durMs, type='sine', gainMul=1){
  ensureAudio();
  if(!audioCtx) return;

  const t0 = audioCtx.currentTime;
  const dur = Math.max(0.005, (durMs||50)/1000);

  const osc  = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = type;
  osc.frequency.setValueAtTime(Math.max(40, +freqHz||440), t0);

  const g = _sfxGainBase() * Math.max(0, gainMul||1);
  gain.gain.setValueAtTime(0.0001, t0);
  gain.gain.exponentialRampToValueAtTime(g, t0 + 0.005);
  gain.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start(t0);
  osc.stop(t0 + dur + 0.01);
}

function playClickSfx(){
  // short, crisp click (not pretty)
  playTone(880, 32, 'square', 0.9);
}

function playConfirmSfx(){
  // slightly longer, two-tone "confirmed" chirp
  playTone(520, 70, 'sine', 0.9);
  setTimeout(()=>playTone(700, 90, 'sine', 0.9), 55);
}

/* Start music on first user gesture */
function armAudioOnFirstGesture(){
  const arm = ()=>{
    try{
      ensureAudio();
      startMenuMusic();
    }catch(e){}
    window.removeEventListener('pointerdown', arm);
    window.removeEventListener('touchstart', arm);
    window.removeEventListener('mousedown', arm);
  };
  window.addEventListener('pointerdown', arm, {passive:true});
  window.addEventListener('touchstart', arm, {passive:true});
  window.addEventListener('mousedown', arm, {passive:true});
}
armAudioOnFirstGesture();







</script>
</body>
</html>
