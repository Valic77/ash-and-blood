<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Ash and Blood</title>


<style>
/* ---------------------------------------------------------------------------
[000] STYLES (BG RESET — NO TITLE LOGO)
--------------------------------------------------------------------------- */
:root{
  --curtain-ms: 0ms;
  --curtain-delay-ms: 0ms;

  /* Background / Title fade timing */
  --bg-in-ms: 1200ms;

  /* Menu buttons fade timing */
  --menu-in-ms: 900ms;
  --menu-delay-ms: 600ms;

  /* UI panel fade timing */
  --ui-fade-ms: 180ms;

  /* Safe gutter to keep panels off the screen edge */
  --ui-gutter: 18px;
}

/* base */
html,body{
  margin:0;
  padding:0;
  height:100%;
  background:#000;
  overflow:hidden;
  touch-action:none;
  font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color:#e9f0ff;
}
canvas{display:block}

/* ---------------------------------------------------------------------------
[000.1] CURTAIN (black overlay)
--------------------------------------------------------------------------- */
#curtain{
  position:fixed;
  inset:0;
  background:#000;
  z-index:9000;
  opacity:1;
  pointer-events:none;
  transition: opacity var(--curtain-ms) linear;
  transition-delay: var(--curtain-delay-ms);
}
#curtain.off{ opacity:0; }

/* ---------------------------------------------------------------------------
[000.2] BOOT SCREEN
--------------------------------------------------------------------------- */
#bootScreen{
  position:fixed;
  inset:0;
  z-index:10000;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#000;
  color:#e9f0ff;
}
#bootScreen.off{
  display:none;
}


/* ---------------------------------------------------------------------------
[000.5] BOOT SCREEN STYLES
--------------------------------------------------------------------------- */
#bootScreen{
  position:fixed;
  inset:0;
  background:#000;
  z-index:25000;
  display:flex;
  align-items:center;
  justify-content:center;
}

#bootScreen.off{
  display:none;
}



/* ---------------------------------------------------------------------------
[000.6] SAVE SLOTS PANEL STYLES
--------------------------------------------------------------------------- */
#slotModal{
  position:fixed;
  inset:0;
  z-index:18000;

  /* ✅ fade instead of blink */
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transition: opacity var(--ui-fade-ms) cubic-bezier(0.2,0,0.2,1),
              visibility 0s linear var(--ui-fade-ms);
}
#slotModal.show{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
  transition: opacity var(--ui-fade-ms) cubic-bezier(0.2,0,0.2,1),
              visibility 0s linear 0s;
}

#slotModal .backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter: blur(6px);
}

#slotModal .slot-panel{
  position:absolute;
  left:50%; top:50%;

  /* keep centered + subtle motion */
  transform:translate(-50%,-50%) scale(0.995);

  /* ✅ never touches edges */
  width:min(560px, calc(100vw - (var(--ui-gutter) * 2)));
  box-sizing:border-box;

  padding:18px;
  border-radius:14px;
  background:rgba(14,18,26,.86);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 18px 60px rgba(0,0,0,.6);

  /* ✅ fade between panels (no blink) */
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transition: opacity var(--ui-fade-ms) cubic-bezier(0.2,0,0.2,1),
              transform var(--ui-fade-ms) cubic-bezier(0.2,0,0.2,1);
}
#slotModal .slot-panel.show{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
  transform:translate(-50%,-50%) scale(1);
}

#slotModal h2{
  margin:0 0 12px 0;
  text-align:center;
  letter-spacing:.12em;
  font-size:18px;
}

.slot-list{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin:10px 0 16px 0;
}

.slot-divider{
  margin:10px 0 10px 0;
  border:none;
  border-top:1px dashed rgba(255,255,255,.14);
  opacity:.7;
}

.slot-actions{
  display:flex;
  flex-direction:column;
  gap:12px;
}




/* ---------------------------------------------------------------------------
[000.7] TITLE SCREEN
--------------------------------------------------------------------------- */
#titleScreen{
  position:fixed;
  inset:0;
  z-index:8000;
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  pointer-events:none;

  /* Use the long mood-light fade here */
  transition: opacity var(--bg-in-ms) cubic-bezier(0.2, 0.0, 0.2, 1);
}

#titleScreen.show{
  opacity:1;
  pointer-events:auto;
}

/* ✅ Instant kill-switch for title overlay (prevents fade-through during gameplay reveal) */
#titleScreen.hard-off{
  transition:none !important;
  opacity:0 !important;
  pointer-events:none !important;
  visibility:hidden !important;
}

/* Background layer (does NOT fade separately; parent controls fade) */
#titleScreen::before{
  content:"";
  position:absolute;
  inset:0;
  z-index:0;
  background-repeat:no-repeat;
  background-position:center;
  background-size:cover;
  background-image: url('img/background.png');
}

#titleCard{
  position:relative;
  z-index:1;
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:14px;
  padding:0;
}

#titleLogo{
  display:block;
  position:relative;
  z-index:2;

  width: min(100vw, 1200px);
  height:auto;

  margin:-15vh auto 4vh auto;

  pointer-events:none;
  background:transparent;
  filter: drop-shadow(0 14px 34px rgba(0,0,0,.6));
}

#mainMenu{
  margin:0;
  display:flex;
  flex-direction:column;
  gap:14px;
  opacity:0;
  transition: opacity var(--menu-in-ms) cubic-bezier(0.2, 0.0, 0.2, 1);
  transition-delay: var(--menu-delay-ms);
  pointer-events:none;
}
#mainMenu.show{opacity:1;pointer-events:auto;}

.menu-btn{
  display:block; /* ✅ IMPORTANT: makes centering consistent everywhere */
  width:min(520px,84vw);margin:0 auto;
  padding:14px 16px;border-radius:12px;
  background:rgba(18,24,34,.42);
  border:1px solid rgba(255,255,255,.16);
  color:#e9f0ff;font-weight:800;
  letter-spacing:.08em;text-transform:uppercase;
  backdrop-filter:blur(6px);

  /* ✅ tactile feedback */
  transition: transform 90ms ease, opacity 120ms ease, filter 120ms ease, border-color 120ms ease;
  user-select:none;
  -webkit-tap-highlight-color: transparent;
}

.menu-btn:active{
  transform:scale(.985);
  opacity:.92;
  filter: brightness(1.12);
  border-color: rgba(255,255,255,.26);
}

/* ✅ Buttons must fit inside modal panels (override global menu-btn width) */
#slotModal .slot-panel .menu-btn,
#optionsModal .options-panel .menu-btn:not(.option-toggle),
#confirmModal .confirm-panel .menu-btn,
#alertModal .alert-panel .menu-btn,
#loadModal .panel .menu-btn{
  width:100% !important;
  margin:0 auto !important;
}

#optionsModal .options-panel .option-toggle{
  width:96px !important;
  margin:0 !important;
}





/* ---------------------------------------------------------------------------
[000.8] OPTIONS MODAL
--------------------------------------------------------------------------- */
#optionsModal{
  position:fixed;
  inset:0;
  z-index:16000;
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transition: opacity var(--ui-fade-ms) cubic-bezier(0.2,0,0.2,1),
              visibility 0s linear var(--ui-fade-ms);
}
#optionsModal.show{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
  transition: opacity var(--ui-fade-ms) cubic-bezier(0.2,0,0.2,1),
              visibility 0s linear 0s;
}
#optionsModal .backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter: blur(6px);
}
#optionsModal .options-panel{
  position:absolute;
  left:50%; top:50%;
  transform:translate(-50%,-50%);
  width:min(560px, calc(100vw - (var(--ui-gutter) * 2)));
  box-sizing:border-box;
  padding:18px;
  border-radius:14px;
  background:rgba(14,18,26,.86);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 18px 60px rgba(0,0,0,.6);
}
#optionsModal h2{
  margin:0 0 12px 0;
  text-align:center;
  letter-spacing:.12em;
  font-size:18px;
}

.opt-row{
  display:grid;
  grid-template-columns: 1fr auto;
  gap:12px;
  align-items:center;
  margin:12px 0;
}

.opt-label{
  font-weight:800;
  letter-spacing:.08em;
  text-transform:uppercase;
  opacity:.9;
}

.opt-vol{
  display:flex;
  flex-direction:column;
  gap:8px;
}

#musicSlider{
  width:100%;
}

#musicPct{
  text-align:right;
  font-weight:800;
  letter-spacing:.08em;
  opacity:.9;
}

.option-toggle{
  width:96px;
  padding:12px 10px;
  border-radius:12px;
  background:rgba(18,24,34,.42);
  border:1px solid rgba(255,255,255,.16);
  color:#e9f0ff;font-weight:900;
  letter-spacing:.08em;text-transform:uppercase;
  user-select:none;
  -webkit-tap-highlight-color: transparent;

  transition: transform 90ms ease, opacity 120ms ease, filter 120ms ease, border-color 120ms ease;
}
.option-toggle:active{
  transform:scale(.985);
  opacity:.92;
  filter: brightness(1.12);
  border-color: rgba(255,255,255,.26);
}

.opt-actions{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin-top:14px;
}


/* ---------------------------------------------------------------------------
[000.9] CONFIRM MODAL
--------------------------------------------------------------------------- */
#confirmModal{
  position:fixed;
  inset:0;
  z-index:17000;
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transition: opacity var(--ui-fade-ms) cubic-bezier(0.2,0,0.2,1),
              visibility 0s linear var(--ui-fade-ms);
}
#confirmModal.show{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
  transition: opacity var(--ui-fade-ms) cubic-bezier(0.2,0,0.2,1),
              visibility 0s linear 0s;
}
#confirmModal .backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter: blur(6px);
}
#confirmModal .confirm-panel{
  position:absolute;
  left:50%; top:50%;
  transform:translate(-50%,-50%);
  width:min(560px, calc(100vw - (var(--ui-gutter) * 2)));
  box-sizing:border-box;
  padding:18px;
  border-radius:14px;
  background:rgba(14,18,26,.86);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 18px 60px rgba(0,0,0,.6);
}
#confirmModal h2{
  margin:0 0 10px 0;
  text-align:center;
  letter-spacing:.12em;
  font-size:18px;
}
#confirmModal p{
  margin:0 0 14px 0;
  text-align:center;
  opacity:.92;
}
.confirm-row{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
  margin-top:12px;
}


/* ---------------------------------------------------------------------------
[000.10] ALERT MODAL
--------------------------------------------------------------------------- */
#alertModal{
  position:fixed;
  inset:0;
  z-index:17500;
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transition: opacity var(--ui-fade-ms) cubic-bezier(0.2,0,0.2,1),
              visibility 0s linear var(--ui-fade-ms);
}
#alertModal.show{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
  transition: opacity var(--ui-fade-ms) cubic-bezier(0.2,0,0.2,1),
              visibility 0s linear 0s;
}
#alertModal .backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter: blur(6px);
}
#alertModal .alert-panel{
  position:absolute;
  left:50%; top:50%;
  transform:translate(-50%,-50%);
  width:min(560px, calc(100vw - (var(--ui-gutter) * 2)));
  box-sizing:border-box;
  padding:18px;
  border-radius:14px;
  background:rgba(14,18,26,.86);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 18px 60px rgba(0,0,0,.6);
}
#alertModal h2{
  margin:0 0 10px 0;
  text-align:center;
  letter-spacing:.12em;
  font-size:18px;
}
#alertModal p{
  margin:0 0 14px 0;
  text-align:center;
  opacity:.92;
}


/* ---------------------------------------------------------------------------
[000.11] LOAD SAVE MODAL
--------------------------------------------------------------------------- */
#loadModal{
  position:fixed;
  inset:0;
  z-index:16500;
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transition: opacity var(--ui-fade-ms) cubic-bezier(0.2,0,0.2,1),
              visibility 0s linear var(--ui-fade-ms);
}
#loadModal.show{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
  transition: opacity var(--ui-fade-ms) cubic-bezier(0.2,0,0.2,1),
              visibility 0s linear 0s;
}
#loadModal .backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter: blur(6px);
}
#loadModal .panel{
  position:absolute;
  left:50%; top:50%;
  transform:translate(-50%,-50%);
  width:min(560px, calc(100vw - (var(--ui-gutter) * 2)));
  box-sizing:border-box;
  padding:18px;
  border-radius:14px;
  background:rgba(14,18,26,.86);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 18px 60px rgba(0,0,0,.6);
}
#loadModal h2{
  margin:0 0 12px 0;
  text-align:center;
  letter-spacing:.12em;
  font-size:18px;
}
.save-list{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin:10px 0 16px 0;
}
.save-item{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.save-item small{
  opacity:.8;
}




</style>

</head>

<body>

<div id="curtain"></div>

<!-- ---------------------------------------------------------------------------
[H000] BOOT SCREEN (sound unlock)
--------------------------------------------------------------------------- -->
<div id="bootScreen">
  <button id="bootStartBtn" class="menu-btn">START</button>
</div>

<!-- ---------------------------------------------------------------------------
[H001] TITLE SCREEN + MAIN MENU (single unified screen)
--------------------------------------------------------------------------- -->
<div id="titleScreen">
  <div id="titleCard">
    <img id="titleLogo" alt="ASH AND BLOOD" src="img/title.png">

    <!-- MAIN MENU -->
    <div id="mainMenu">
      <button id="btnNew" class="menu-btn">START GAME</button>
      <button id="btnOptions" class="menu-btn">OPTIONS</button>
    </div>
  </div>
</div>


<!-- ---------------------------------------------------------------------------
[H002] SAVE SLOTS PANEL (textbox)
--------------------------------------------------------------------------- -->
<div id="slotModal" aria-label="Save Slots Panel">
  <div class="slot-backdrop"></div>

  <!-- PANEL A: CHOOSE SLOT -->
  <div class="slot-panel" id="panelSlots">
    <div class="slot-title">CHOOSE SAVE SLOT</div>

    <div id="slotList"></div>

    <div class="slot-divider" aria-hidden="true"></div>

    <button id="btnSlotsClose" class="menu-btn">CLOSE</button>
  </div>

  <!-- PANEL B: NAME SURVIVOR -->
  <div class="slot-panel" id="panelName">
    <div class="slot-title">NAME SURVIVOR</div>

    <input id="nameInput" type="text" maxlength="16" placeholder="Enter name..." />

    <div class="slot-divider" aria-hidden="true"></div>

    <div class="slot-row">
      <button id="btnNameConfirm" class="menu-btn">CONFIRM</button>
      <button id="btnNameCancel" class="menu-btn">CANCEL</button>
    </div>
  </div>

  <!-- PANEL C: ACTIONS -->
  <div class="slot-panel" id="panelActions">
    <div class="slot-title" id="actionTitle">SAVE</div>

    <div class="slot-divider" aria-hidden="true"></div>

    <div class="slot-row">
      <button id="btnLoadSlot" class="menu-btn">LOAD SAVE</button>
      <button id="btnDeleteSlot" class="menu-btn">DELETE SAVE</button>
    </div>

    <button id="btnActionsClose" class="menu-btn">CLOSE</button>
  </div>

  <!-- PANEL D: CONFIRM DELETE -->
  <div class="slot-panel" id="panelConfirm">
    <div class="slot-title">ARE YOU SURE?</div>

    <div class="slot-divider" aria-hidden="true"></div>

    <div class="slot-row">
      <button id="btnDeleteYes" class="menu-btn">YES</button>
      <button id="btnDeleteNo" class="menu-btn">NO</button>
    </div>

    <button id="btnConfirmClose" class="menu-btn">CLOSE</button>
  </div>
</div>

<!-- ---------------------------------------------------------------------------
[H003] OPTIONS PANEL (textbox)
--------------------------------------------------------------------------- -->
<div id="optionsModal" aria-label="Options Panel">
  <div class="options-backdrop"></div>

  <div class="options-panel">
    <div class="slot-title">OPTIONS</div>

    <div class="options-row">
      <label for="musicVol">MUSIC</label>
      <input id="musicVol" type="range" min="0" max="100" value="50" />
      <button id="musicToggleBtn" class="menu-btn option-toggle" type="button">ON</button>
    </div>

    <div class="options-row" style="justify-content:flex-end; margin-top:-6px;">
      <div id="musicVolLabel" class="options-value">50%</div>
    </div>

    <button id="btnOptionsClose" class="menu-btn">CLOSE</button>
  </div>
</div>

<!-- ---------------------------------------------------------------------------
[H004] CONFIRM MODAL (Apply Changes)
--------------------------------------------------------------------------- -->
<div id="confirmModal" aria-label="Confirm Modal">
  <div class="confirm-backdrop"></div>

  <div class="confirm-panel">
    <div class="slot-title">APPLY CHANGES?</div>

    <div class="confirm-row">
      <button id="btnConfirmNo" class="menu-btn">NO</button>
      <button id="btnConfirmYes" class="menu-btn">YES</button>
    </div>
  </div>
</div>


<!-- ---------------------------------------------------------------------------
[H005] ALERT MODAL (replaces browser alert())
--------------------------------------------------------------------------- -->
<div id="alertModal" aria-label="Alert Modal">
  <div class="alert-backdrop"></div>

  <div class="alert-panel">
    <div class="slot-title">NOTICE</div>
    <div id="alertMsg" class="alert-msg">Message</div>
    <button id="btnAlertOk" class="menu-btn">OK</button>
  </div>
</div>




<!-- ---------------------------------------------------------------------------
[GX01] GAMEPLAY UI + CANVAS
--------------------------------------------------------------------------- -->

<div id="hud">
  <div class="hud-pill">HP <span id="hp">100</span></div>
  <div class="hud-pill">LV <span id="lv">1</span></div>
</div>

<div id="pad-left" class="pad"><div class="stick"></div></div>
<div id="pad-right" class="pad"><div class="stick"></div></div>

<div id="modeBtn">AUTO FIRE</div>
<div id="fireBtn">FIRE</div>

<canvas id="game"></canvas>

<script>
/* ---------------------------------------------------------------------------
[001] UTIL: seeded RNG
--------------------------------------------------------------------------- */
function RNG(seed){
  this.s=seed>>>0
}
RNG.prototype.next=function(){
  this.s=(this.s*1664525+1013904223)>>>0
  return this.s/4294967296
}

/* ---------------------------------------------------------------------------
[002] CANVAS + CAMERA
--------------------------------------------------------------------------- */
const canvas=document.getElementById('game')
const ctx=canvas.getContext('2d')
function resize(){
  canvas.width=innerWidth
  canvas.height=innerHeight
}
addEventListener('resize',resize)
resize()

const camera={x:0,y:0,zoom:1}

/* ---------------------------------------------------------------------------
[003] INPUT: virtual sticks
--------------------------------------------------------------------------- */
function Stick(el){
  this.el=el
  this.knob=el.querySelector('.stick')
  this.active=false
  this.dx=0; this.dy=0
  el.addEventListener('pointerdown',e=>{
    this.active=true
    this.ox=e.clientX; this.oy=e.clientY
  })
  addEventListener('pointermove',e=>{
    if(!this.active) return
    let x=e.clientX-this.ox
    let y=e.clientY-this.oy
    const d=Math.hypot(x,y)
    if(d>40){x*=40/d;y*=40/d}
    this.dx=x/40; this.dy=y/40
    this.knob.style.transform=`translate(${x}px,${y}px)`
  })
  addEventListener('pointerup',()=>{
    this.active=false
    this.dx=this.dy=0
    this.knob.style.transform='translate(0,0)'
  })
}
const moveStick=new Stick(document.getElementById('pad-left'))
const aimStick=new Stick(document.getElementById('pad-right'))

/* ---------------------------------------------------------------------------
[004] WORLD: procedural outdoor map
--------------------------------------------------------------------------- */
const TILE=96
const MAP_W=20, MAP_H=20
const world=[]
const rng=new RNG(12345)

for(let y=0;y<MAP_H;y++){
  for(let x=0;x<MAP_W;x++){
    world.push({
      x,y,
      type:rng.next()<.1?'building':'street'
    })
  }
}

/* ---------------------------------------------------------------------------
[005] PLAYER
--------------------------------------------------------------------------- */
const player={
  x:MAP_W*TILE/2,
  y:MAP_H*TILE/2,
  a:0,
  hp:100
}

/* ---------------------------------------------------------------------------
[006] ENEMIES
--------------------------------------------------------------------------- */
const enemies=[]
for(let i=0;i<6;i++){
  enemies.push({
    x:rng.next()*MAP_W*TILE,
    y:rng.next()*MAP_H*TILE,
    a:rng.next()*Math.PI*2,
    state:'idle'
  })
}

/* ---------------------------------------------------------------------------
[007] UPDATE LOOP
--------------------------------------------------------------------------- */
let autoFire=true
const modeBtn=document.getElementById('modeBtn')
modeBtn.onclick=()=>{
  autoFire=!autoFire
  modeBtn.textContent=autoFire?'AUTO FIRE':'MANUAL'
}

function update(dt){
  // movement
  const spd=2
  if(moveStick.active){
    player.x+=moveStick.dx*spd*dt
    player.y+=moveStick.dy*spd*dt
    if(!aimStick.active){
      player.a=Math.atan2(moveStick.dy,moveStick.dx)
    }
  }
  if(aimStick.active){
    player.a=Math.atan2(aimStick.dy,aimStick.dx)
  }

  camera.x=player.x
  camera.y=player.y
}

/* ---------------------------------------------------------------------------
[008] RENDER
--------------------------------------------------------------------------- */
function draw(){
  ctx.setTransform(1,0,0,1,0,0)
  ctx.clearRect(0,0,canvas.width,canvas.height)

  ctx.translate(canvas.width/2,canvas.height/2)
  ctx.scale(camera.zoom,camera.zoom)
  ctx.translate(-camera.x,-camera.y)

  // tiles
  for(const t of world){
    ctx.fillStyle=t.type==='building'?'#2b3444':'#3a4558'
    ctx.fillRect(t.x*TILE,t.y*TILE,TILE,TILE)
  }

  // enemies
  for(const e of enemies){
    ctx.fillStyle='#6aff6a'
    ctx.beginPath()
    ctx.arc(e.x,e.y,14,0,Math.PI*2)
    ctx.fill()
  }

  // player
  ctx.save()
  ctx.translate(player.x,player.y)
  ctx.rotate(player.a)
  ctx.fillStyle='#dfe7ff'
  ctx.fillRect(-10,-14,20,28)
  ctx.fillStyle='#ff5555'
  ctx.fillRect(8,-3,10,6)
  ctx.restore()

  // vignette
  const g=ctx.createRadialGradient(
    camera.x,camera.y,200,
    camera.x,camera.y,800
  )
  g.addColorStop(0,'rgba(0,0,0,0)')
  g.addColorStop(1,'rgba(0,0,0,.6)')
  ctx.fillStyle=g
  ctx.fillRect(
    camera.x-1000,camera.y-1000,
    2000,2000
  )
}

/* ---------------------------------------------------------------------------
[009] TITLE FLOW + SAVE SLOTS (black -> title -> menu)
--------------------------------------------------------------------------- */

/* Core UI */
const titleScreen = document.getElementById('titleScreen');
const curtain     = document.getElementById('curtain');
const mainMenu    = document.getElementById('mainMenu');
const btnNew      = document.getElementById('btnNew');
const btnOptions  = document.getElementById('btnOptions');

/* Save Slots UI */
const slotModal     = document.getElementById('slotModal');
const slotBackdrop  = slotModal ? slotModal.querySelector('.slot-backdrop') : null;
const slotList      = document.getElementById('slotList');

const panelSlots    = document.getElementById('panelSlots');
const panelName     = document.getElementById('panelName');
const panelActions  = document.getElementById('panelActions');
const panelConfirm  = document.getElementById('panelConfirm');

const nameInput     = document.getElementById('nameInput');
const actionTitle   = document.getElementById('actionTitle');

const btnSlotsClose   = document.getElementById('btnSlotsClose');
const btnNameConfirm  = document.getElementById('btnNameConfirm');
const btnNameCancel   = document.getElementById('btnNameCancel');

const btnLoadSlot     = document.getElementById('btnLoadSlot');
const btnDeleteSlot   = document.getElementById('btnDeleteSlot');
const btnActionsClose = document.getElementById('btnActionsClose');

const btnDeleteYes    = document.getElementById('btnDeleteYes');
const btnDeleteNo     = document.getElementById('btnDeleteNo');
const btnConfirmClose = document.getElementById('btnConfirmClose');

/* Options / modals (optional) */
const optionsModal = document.getElementById('optionsModal');
const confirmModal = document.getElementById('confirmModal');
const alertModal   = document.getElementById('alertModal');

/* ---------------------------------------------------------------------------
Mobile-safe tap binding (fixes “dead button” on Android)
--------------------------------------------------------------------------- */
function bindTap(el, fn){
  if(!el) return;

  let locked = false;
  const run = (e)=>{
    // prevent ghost clicks / double fire
    if(locked) return;
    locked = true;
    setTimeout(()=>{ locked = false; }, 250);

    try{
      if(e){
        e.preventDefault?.();
        e.stopPropagation?.();
      }
    }catch(_){}

    try{ fn(); }catch(err){
      // fail silently in production; prevents total UI death
      console.warn('Tap handler error:', err);
    }
  };

  el.addEventListener('pointerup', run, {passive:false});
  el.addEventListener('touchend', run, {passive:false});
  el.addEventListener('click', run);
}

/* ---------------------------------------------------------------------------
Title sequence timers
--------------------------------------------------------------------------- */
let titleTimers = [];
function clearTitleTimers(){
  for(const t of titleTimers) clearTimeout(t);
  titleTimers.length = 0;
}
function schedule(fn, ms){
  const t = setTimeout(fn, ms);
  titleTimers.push(t);
  return t;
}

function showCurtain(ms=0, delay=0){
  if(!curtain) return;
  document.documentElement.style.setProperty('--curtain-ms', ms+'ms');
  document.documentElement.style.setProperty('--curtain-delay-ms', delay+'ms');
  curtain.classList.remove('off'); // black
}
function hideCurtain(ms=0, delay=0){
  if(!curtain) return;
  document.documentElement.style.setProperty('--curtain-ms', ms+'ms');
  document.documentElement.style.setProperty('--curtain-delay-ms', delay+'ms');
  curtain.classList.add('off'); // transparent
}

/* Boot -> Title -> Menu */
function runTitleSequence(){
  clearTitleTimers();

  showCurtain(0,0);

  if(titleScreen){
    titleScreen.classList.remove('show');
    titleScreen.classList.remove('hard-off');
    titleScreen.style.display = 'flex';
  }
  if(mainMenu) mainMenu.classList.remove('show');

  const bootScreen = document.getElementById('bootScreen');
  if(bootScreen) bootScreen.classList.remove('off');
  schedule(()=> bootScreen && bootScreen.classList.add('off'), 220);

  schedule(()=>{
    titleScreen && titleScreen.classList.add('show');
    hideCurtain(850, 0);
  }, 260);

  schedule(()=>{
    mainMenu && mainMenu.classList.add('show');
    if(typeof ensureTitleMusic === 'function') ensureTitleMusic();
  }, 1200);
}

/* ---------------------------------------------------------------------------
Slots: panels
--------------------------------------------------------------------------- */
let selectedSlot = null;
let currentPanel = 'slots';
let previousPanel = 'slots';
const SLOT_COUNT = 5;

function hideAllPanels(){
  panelSlots && panelSlots.classList.remove('show');
  panelName && panelName.classList.remove('show');
  panelActions && panelActions.classList.remove('show');
  panelConfirm && panelConfirm.classList.remove('show');
}

function showPanel(which){
  hideAllPanels();
  currentPanel = which;

  if(which === 'slots')   panelSlots && panelSlots.classList.add('show');
  if(which === 'name')    panelName && panelName.classList.add('show');
  if(which === 'actions') panelActions && panelActions.classList.add('show');
  if(which === 'confirm') panelConfirm && panelConfirm.classList.add('show');
}

function openSlots(){
  selectedSlot = null;
  previousPanel = 'slots';
  showPanel('slots');
  rebuildSlotList();
  slotModal && slotModal.classList.add('show');
}

function closeSlots(){
  slotModal && slotModal.classList.remove('show');
  selectedSlot = null;
  previousPanel = 'slots';
  currentPanel = 'slots';
  if(nameInput) nameInput.value = '';
}

/* Save helpers (expected to exist elsewhere; safe fallback) */
function slotKey(i){ return `AAB_SAVE_${i}`; }
function slotHasSave(i){
  try{
    const raw = localStorage.getItem(slotKey(i));
    return !!raw;
  }catch(_){ return false; }
}
function getSlotName(i){
  try{
    const raw = localStorage.getItem(slotKey(i));
    if(!raw) return '';
    const data = JSON.parse(raw);
    return (data && data.name) ? String(data.name) : '';
  }catch(_){ return ''; }
}

/* Build slot buttons */
function rebuildSlotList(){
  if(!slotList) return;
  slotList.innerHTML = '';

  for(let i=1;i<=SLOT_COUNT;i++){
    const nm = getSlotName(i);
    const has = slotHasSave(i);

    const btn = document.createElement('button');
    btn.className = 'menu-btn';
    btn.textContent = nm ? nm : `${i} ---NEW GAME---`;

    bindTap(btn, ()=>{
      selectedSlot = i;

      if(nm && has){
        if(actionTitle) actionTitle.textContent = nm;
        previousPanel = 'slots';
        showPanel('actions');
      }else{
        previousPanel = 'slots';
        showPanel('name');
        if(nameInput){
          nameInput.value = '';
          setTimeout(()=>nameInput.focus(), 50);
        }
      }
    });

    slotList.appendChild(btn);
  }
}

/* ---------------------------------------------------------------------------
CINEMATIC ENTER GAME (your required flow)
--------------------------------------------------------------------------- */
function cinematicIntoGame(){
  clearTitleTimers();

  if(typeof playUiConfirm === 'function') playUiConfirm();

  const CONFIRM_LEAD_MS = 180;

  setTimeout(()=>{

    // Close open UI
    closeSlots();
    if(optionsModal && optionsModal.classList.contains('show')) optionsModal.classList.remove('show');
    if(confirmModal && confirmModal.classList.contains('show')) confirmModal.classList.remove('show');
    if(alertModal && alertModal.classList.contains('show')) alertModal.classList.remove('show');

    // Show clean title (no buttons)
    if(mainMenu) mainMenu.classList.remove('show');

    if(titleScreen){
      titleScreen.style.display = 'flex';
      titleScreen.classList.remove('hard-off');
      titleScreen.classList.add('show');
    }

    // Hold 2 seconds on clean title
    const HOLD_ON_TITLE_MS = 2000;

    setTimeout(()=>{

      const FADE_TO_BLACK_MS = 1200;

      if(curtain){
        curtain.style.transition = 'opacity 1200ms cubic-bezier(0.2,0,0.2,1)';
        curtain.classList.remove('off');
      }
      if(typeof fadeOutTitleMusic === 'function') fadeOutTitleMusic(FADE_TO_BLACK_MS);

      setTimeout(()=>{

        if(typeof stopTitleMusic === 'function') stopTitleMusic();

        if(titleScreen){
          titleScreen.classList.add('hard-off');
          titleScreen.style.display = 'none';
        }

        let maybePromise = null;
        try{ maybePromise = (typeof startGameplay === 'function') ? startGameplay() : null; }catch(e){ maybePromise = null; }

        Promise.resolve(maybePromise).then(()=>{
          if(curtain){
            curtain.style.transition = 'opacity 1200ms cubic-bezier(0.2,0,0.2,1)';
            curtain.classList.add('off');
          }
        });

      }, FADE_TO_BLACK_MS + 60);

    }, HOLD_ON_TITLE_MS);

  }, CONFIRM_LEAD_MS);
}

/* ---------------------------------------------------------------------------
Wire up buttons (START must NEVER be dead)
--------------------------------------------------------------------------- */
bindTap(btnNew, openSlots);
bindTap(btnOptions, ()=>{ if(optionsModal) optionsModal.classList.add('show'); });

bindTap(btnSlotsClose, closeSlots);
if(slotBackdrop) bindTap(slotBackdrop, closeSlots);

bindTap(btnNameCancel, ()=>{ previousPanel='slots'; showPanel('slots'); });

bindTap(btnNameConfirm, ()=>{
  const nm = (nameInput ? nameInput.value : '').trim();
  if(!nm){
    if(typeof showAlert === 'function') showAlert('NOTICE', 'Please enter a name');
    return;
  }
  const slot = selectedSlot || 1;
  if(typeof createNewSave === 'function') createNewSave(slot, nm);
  else{
    // minimal fallback save so flow works even if createNewSave missing
    try{ localStorage.setItem(slotKey(slot), JSON.stringify({name:nm, t:Date.now()})); }catch(_){}
  }
  cinematicIntoGame();
});

bindTap(btnLoadSlot, cinematicIntoGame);

bindTap(btnActionsClose, ()=>{ showPanel('slots'); });

bindTap(btnDeleteSlot, ()=>{ showPanel('confirm'); });

bindTap(btnDeleteYes, ()=>{
  const slot = selectedSlot || 1;
  if(typeof deleteSave === 'function') deleteSave(slot);
  else{
    try{ localStorage.removeItem(slotKey(slot)); }catch(_){}
  }
  showPanel('slots');
  rebuildSlotList();
});

bindTap(btnDeleteNo, ()=>{ showPanel('actions'); });
bindTap(btnConfirmClose, ()=>{ showPanel('actions'); });

/* Kick title */
runTitleSequence();






/* ---------------------------------------------------------------------------
[010] GAME LOOP (disabled until later phases)
--------------------------------------------------------------------------- */
function startGameplay(){
  const canvas = document.getElementById('game');

  // reveal gameplay only when this is explicitly called
  canvas.classList.add('show');

  let last = 0;
  function loop(t){
    const dt = (t - last) / 16;
    last = t;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
}

/* ---------------------------------------------------------------------------
[011] AUDIO: BOOT SCREEN → TITLE MUSIC (delay + gain fade, no pop, no cut)
--------------------------------------------------------------------------- */

/* FILE PATH (matches your repo structure) */
const TITLE_MUSIC_SRC = 'audio/title.mp3';

/* Defaults */
const TITLE_MUSIC_DEFAULT_GAIN = 0.50;  // 0.0–1.0

/* Settings keys (persisted) */
const OPT_MUSIC_VOL_KEY   = 'AAB_OPT_MUSIC_VOL';
const OPT_MUSIC_LAST_KEY  = 'AAB_OPT_MUSIC_LAST'; // ✅ last non-zero

let audioCtx = null;
let titleBuf  = null;
let titleSrc  = null;
let titleGain = null;

let musicVolume = TITLE_MUSIC_DEFAULT_GAIN;       // current applied volume (0..1)
let lastNonZeroMusicVolume = TITLE_MUSIC_DEFAULT_GAIN;

/* --------------------------
   Settings (global music via volume)
-------------------------- */
function loadAudioPrefs(){
  const rawVol = localStorage.getItem(OPT_MUSIC_VOL_KEY);
  if(rawVol != null){
    const v = Number(rawVol);
    if(Number.isFinite(v)) musicVolume = Math.max(0, Math.min(1, v));
  }

  const rawLast = localStorage.getItem(OPT_MUSIC_LAST_KEY);
  if(rawLast != null){
    const v = Number(rawLast);
    if(Number.isFinite(v)) lastNonZeroMusicVolume = Math.max(0, Math.min(1, v));
  }

  // If now muted but we never stored a last non-zero, seed it
  if(musicVolume > 0.001) lastNonZeroMusicVolume = musicVolume;
}

function saveAudioPrefs(){
  localStorage.setItem(OPT_MUSIC_VOL_KEY, String(musicVolume));
  localStorage.setItem(OPT_MUSIC_LAST_KEY, String(lastNonZeroMusicVolume));
}

function getMusicVolume(){ return musicVolume; }

/* Call whenever slider changes */
function setMusicVolume(v){
  const vv = Math.max(0, Math.min(1, Number(v) || 0));
  musicVolume = vv;

  // Track last non-zero volume so ON can restore it
  if(vv > 0.001) lastNonZeroMusicVolume = vv;

  applyTitleMusicState();
  saveAudioPrefs();
}

/* Toggle ON/OFF button */
function toggleMusicOnOff(){
  if(musicVolume > 0.001){
    // turn OFF (remember last non-zero)
    lastNonZeroMusicVolume = musicVolume;
    musicVolume = 0;
  }else{
    // turn ON (restore last non-zero)
    musicVolume = (lastNonZeroMusicVolume > 0.001) ? lastNonZeroMusicVolume : TITLE_MUSIC_DEFAULT_GAIN;
  }
  applyTitleMusicState();
  saveAudioPrefs();
}

/* --------------------------
   Audio engine
-------------------------- */
function ensureAudio(){
  if(audioCtx) return;
  const Ctx = window.AudioContext || window.webkitAudioContext;
  audioCtx = new Ctx();

  // Load buffer once
  fetch(TITLE_MUSIC_SRC)
    .then(r=>r.arrayBuffer())
    .then(buf=>audioCtx.decodeAudioData(buf))
    .then(decoded=>{
      titleBuf = decoded;
      // If menu is visible, auto-start after load
      if(isMenuVisible()){
        startTitleMusicNow();
        fadeInTitleMusic();
      }
    })
    .catch(err=>{
      console.warn('Title music load failed:', err);
    });
}

function isMenuVisible(){
  const ts = document.getElementById('titleScreen');
  const mm = document.getElementById('mainMenu');
  if(!ts || !mm) return false;
  if(getComputedStyle(ts).display === 'none') return false;
  return ts.classList.contains('show') && mm.classList.contains('show');
}

/* Start title loop (used at boot + when enabling while on menu and nothing is running) */
function startTitleMusicNow(){
  if(!titleBuf) return;

  // Stop any existing to prevent overlap
  stopTitleMusic();

  if(!titleGain){
    titleGain = audioCtx.createGain();
    titleGain.connect(audioCtx.destination);
  }

  titleSrc = audioCtx.createBufferSource();
  titleSrc.buffer = titleBuf;
  titleSrc.loop = true;
  titleSrc.connect(titleGain);

  // Start silent, then fade to target
  titleGain.gain.setValueAtTime(0, audioCtx.currentTime);
  titleSrc.start(0);
}

/* Public: start (ensures audio + starts loop if on menu) */
function startTitleMusic(){
  ensureAudio();
  if(!audioCtx) return;

  // Must resume on user gesture
  if(audioCtx.state === 'suspended'){
    audioCtx.resume().catch(()=>{});
  }

  // If already playing, just update gain
  if(titleSrc){
    applyTitleMusicState();
    return;
  }

  // If buffer not loaded yet, it will start when loaded
  if(titleBuf && isMenuVisible()){
    startTitleMusicNow();
    fadeInTitleMusic();
  }
}

function stopTitleMusic(){
  try{
    if(titleSrc){
      titleSrc.stop(0);
      titleSrc.disconnect();
    }
  }catch(e){}
  titleSrc = null;
}

/* Smooth gain to current slider target */
function fadeInTitleMusic(ms=600){
  if(!audioCtx || !titleGain) return;
  const now = audioCtx.currentTime;
  const target = (musicVolume > 0.001) ? musicVolume : 0.0;

  titleGain.gain.cancelScheduledValues(now);
  titleGain.gain.setValueAtTime(titleGain.gain.value, now);
  titleGain.gain.linearRampToValueAtTime(target, now + (ms/1000));
}

function fadeOutTitleMusic(ms=800){
  if(!audioCtx || !titleGain) return;
  const now = audioCtx.currentTime;

  titleGain.gain.cancelScheduledValues(now);
  titleGain.gain.setValueAtTime(titleGain.gain.value, now);
  titleGain.gain.linearRampToValueAtTime(0.0, now + (ms/1000));
}

/* Keep gain in sync; start/stop if needed */
function applyTitleMusicState(){
  if(!audioCtx) return;

  // If we're on menu, have buffer, and music should be audible but nothing is playing, start it.
  if(titleBuf && !titleSrc && isMenuVisible()){
    startTitleMusicNow();
  }

  if(titleGain){
    const now = audioCtx.currentTime;
    const target = (musicVolume > 0.001) ? musicVolume : 0.0;

    titleGain.gain.cancelScheduledValues(now);
    titleGain.gain.setValueAtTime(titleGain.gain.value, now);
    titleGain.gain.linearRampToValueAtTime(target, now + 0.08);
  }

  // If muted, stop after short fade to save CPU
  if(musicVolume <= 0.001 && titleSrc){
    fadeOutTitleMusic(180);
    setTimeout(()=>{ stopTitleMusic(); }, 220);
  }
}

/* Called by title flow when showing menu */
function ensureTitleMusic(){
  startTitleMusic();
  // If it's already playing, fade to target
  setTimeout(()=> fadeInTitleMusic(700), 60);
}

/* Boot init */
loadAudioPrefs();




/* ---------------------------------------------------------------------------
[012] UI SFX: button click + confirm (no external files)
--------------------------------------------------------------------------- */
function playUiClick(){
  if(!audioCtx) return;
  try{
    const now = audioCtx.currentTime;

    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();

    o.type = 'square';
    o.frequency.setValueAtTime(900, now);

    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.10, now + 0.004);
    g.gain.exponentialRampToValueAtTime(0.0001, now + 0.060);

    o.connect(g);
    g.connect(audioCtx.destination);

    o.start(now);
    o.stop(now + 0.065);
  }catch(e){}
}

function playUiConfirm(){
  if(!audioCtx) return;
  try{
    const now = audioCtx.currentTime;

    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();

    o.type = 'sine';
    o.frequency.setValueAtTime(520, now);
    o.frequency.exponentialRampToValueAtTime(740, now + 0.10);

    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.14, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + 0.14);

    o.connect(g);
    g.connect(audioCtx.destination);

    o.start(now);
    o.stop(now + 0.15);
  }catch(e){}
}

/* Global UI click hook (buttons + tap targets)
   - runs in capture phase so it still plays even if the click handler throws
   - skips Boot button (that one is “special” and already a gesture)
*/
document.addEventListener('click', (e)=>{
  const el = e.target && e.target.closest
    ? e.target.closest('button, .menu-btn, .save-item, #modeBtn, #fireBtn')
    : null;
  if(!el) return;
  if(el.id === 'bootStartBtn') return;

  playUiClick();
}, true);





</script>
</body>
</html>
